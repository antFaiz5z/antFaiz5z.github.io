---
title: 《Redis 设计与实现》阅读笔记
comments: true
toc: true
date: 2019-05-17 10:43:24
categories: C/C++
tags: Redis
---

第一版.

<!--more-->

## 数据结构与对象

Redis 没有直接使用以下几种数据结构来实现键值对数据库, 而是基于这些数据结构创建了一个对象系统.
Redis 的每个键值对都是由对象组成, 键总是一个字符串对象, 值可以是字符串对象、列表对象、哈希对象、集合对象、有序集合对象.

### sds

Redis 使用 SDS 用作默认字符串表示, C 字符串只会作为字符串字面量用在一些无需对字符串进行修改的地方如打印日志.

![](/images/redis-sds.png)

### linkedlist

链表 (双向无环) 是列表键的底层实现之一.

![](/images/redis-list.png)

### dict/ht

Redis 的数据库使用字典来作为底层实现, 字典还是哈希键的底层实现之一.
字典 使用哈希表作为底层实现.
哈希表 使用链地址法 (separate chaining) 来解决键冲突.

![](/images/redis-ht.png)

### skiplist

Redis 使用跳跃表作为有序集合键的底层实现之一.
Redis 只在两个地方用到了跳跃表, 一个是实现有序集合键, 一个是在集群节点中用作内部数据结构.
每个跳跃表节点的层高都是 1~32 之间的随机数.
在同一跳跃表中, 多个节点可以包含相同的分值, 但每个节点的成员对象必须是唯一的.
跳跃表中的节点按照分值大小进行排序, 当分值相同时, 节点按照成员对象大小进行排序.

![](/images/redis-sl.png)

### intset

整数集合是集合键的底层实现之一.
证书集合的底层实现为数组, 这个数组以有序、无重复的方式保存几何元素, 在有需要的时候, 程序会根据新添加元素的类型，改变这个数组的类型. (类型有INSERT_ENC_INT16/32/64)
整数集合只支持升级操作, 不支持降级操作.

![](/images/redis-intset.png)

### ziplist

压缩列表被用作列表键和哈希键的底层实现之一.
压缩列表是一种为节约内存而开发的顺序性数据结构.
压缩列表可以包含多个节点, 每个节点可以保存一个字节数组或整数值.
在压缩列表中添加新节点或者删除节点, 可能会引发连锁更新操作, 但这种操作出现的几率并不高.

![](/images/redis-ziplist1.png)

![](/images/redis-ziplist2.png)

### 对象

当我们称呼一个键为 "列表键" 时, 我们指的是 "这个数据库键所对应的值为列表对象".

Redis 的对象系统实现了基于引用计数的内存回收机制, 继而实现了对象共享机制.
Redis 的对象带有访问时间记录信息, 可用于计算数据库键的空转时长, 在服务器启用了 maxmemory 功能的情况下, 空转时长较大的那些键可能会优先被服务器删除.

TYPE 命令返回数据库键对应的值对象的类型, 而不是键对象的类型.

字符串对象是 Redis 五种类型对象中唯一一种会被其他四种对象嵌套的对象.

Redis 只对包含整数值的字符串对象进行共享, 因为尽管共享更复杂对象可以节省更多内存, 但验证操作的时间复杂度也更高.

Redis 在初始化服务器时, 会预先创建一万个字符串对象用于共享, 包含从 0 至 9999 所有整数值.

## 单机数据库

过期键删除策略有定时删除、惰性删除、定期删除, Redis 采用的是后两种, 服务器可以很好地在合理使用 CPU 时间和避免浪费内存空间之间取得平衡.


## 多机数据库

## 独立功能
